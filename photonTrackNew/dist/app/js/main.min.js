function showCalenderIfPermitted(){chrome.storage.local.get("cal",function(e){e&&e.cal&&e.cal.permitted?(console.log("Calendar value is availble and will be visible"),app.calenderShown=!0,calendarDisplayLogic(app.calenderData),showContent("googleCal")):console.log("Calendar is not shown")})}function checkWeeklyMonthlyData(){app.weekAndMonthData.month&&app.weekAndMonthData.week&&!app.settingsMode&&(document.getElementById("weeklyMonthlyBlock").className="",renderStatus(app.weekAndMonthData.week[0].avg_hrs,"weekly"),renderStatus(app.weekAndMonthData.month[0].avg_hrs,"monthly"),toggleLoader(!1),showCalenderIfPermitted())}function main(e){getFactory("month",function(e){app.weekAndMonthData.month=e,checkWeeklyMonthlyData()},function(){console.log("failure")}),app.weekAndMonthData.week||getFactory("week",function(e){app.weekAndMonthData.week=e,checkWeeklyMonthlyData()},function(){console.log("failure")}),getFactory("today",function(e){parseData(e,function(e,t){renderStatus("Hi "+user.name),renderStatus(myTime.inTime,"inTime"),renderStatus(e,"totalTime"),myTime.crossedNineHours?renderStatus("Bye Bye","expectedExit"):renderStatus(t,"expectedExit")},function(e){renderStatus("Error : "+e)})},function(e){renderStatus("Error : "+e)})}function launchChecks(){chrome.storage.local.get("user",function(e){e&&e.user&&e.user.eCode?(toggleLoader(!0),stch(null,!0)):stch(null,!0)})}function getDataAfterPulseAndAccesssControl(e){getFactory("week",function(e){app.weekAndMonthData.week=e;var t=e[0].displayName;user.name=t.split(" ")[0],user.eCode=e[0].employeeId,chrome.storage.local.set({user:user},function(){app.settingsMode=!1,toggleLoader(!0),hideContent(["walkThrough","settingsPage"]),document.getElementById("topCornerIcon").classList.remove("home-logo"),showContent(["homePage","header","topCornerIcon"]),main(user.eCode)})},function(){console.log("failure"),toggleLoader(!1)})}function timeFormatter(e){return e=String(e),e.length<2?"0"+e:e}function inTimeFormatter(e){var t=e.split(":");return t[0]>12?(t[0]=t[0]-12,t[0]+":"+t[1]+" pm"):12==t[0]?e+" pm":e+" am"}function howLongToCompleteNineHours(e,t){var a,n,o=null;if(t>0&&9>e?(n=8-e,a=60-t):0==t&&9>e?(n=9-e,a=60):e>=9&&(myTime.crossedNineHours=!0),null!==n&&void 0!==n&&null!==a&&void 0!==a){var r,s=new Date,c=s.getHours()+n,i=s.getMinutes()+a;i>60&&(i-=60,c++),c>=24&&(c-=24),c>12?(r="pm",c-=12):r="am",o=c+":"+timeFormatter(i)+" "+r}return o}function changeJsTimeToHumanTime(e,t){var a=e/1e3,n=Math.floor(a%60);a/=60;var o=Math.floor(a%60);a/=60;var r=Math.floor(a%24);if(t)return[r,o];var s=timeFormatter(r)+":"+timeFormatter(o)+":"+timeFormatter(n);return s}function floorLevelHoursCalculator(e){if(e.length>0){var t=0;for(var a in e)a=Number(a),"entry"===e[a].swipeType.toLowerCase()&&e[a+1]&&"exit"===e[a+1].swipeType.toLowerCase()?(tempVal=e[a+1].jsDate-e[a].jsDate,t+=tempVal):a+1===e.length&&e.length%2===1&&"entry"===e[a].swipeType.toLowerCase()&&(tempVal=new Date-e[a].jsDate,t+=tempVal);return t}}function parseData(e,t,a){var n=[],o=[],r=[];if(!e||0==e.length)return void a("Presently, no swipe in data");var s=e[0].data[1].split(":");s=s[0]+":"+s[1],myTime.inTime=inTimeFormatter(s);for(var c in e)if(e.hasOwnProperty(c)){var i=e[c],l=new Date(i.data[0].replace(/-/g,"/")+" "+i.data[1]),u={};u.time=i.data[1],u.jsDate=l,u.swipeType=i.data[2],u.status=i.data[5];var d=i.data[3];r[d]||(r[d]=[]),r[d].push(u),"ground"===i.data[3].toLowerCase()?n.push(u):"second"===i.data[3].toLowerCase()&&o.push(u)}var m=0;for(var d in r)r[d].length>0&&(m+=floorLevelHoursCalculator(r[d]));myTime.calculatedTotalMs=m,myTime.convertedTotalTime=changeJsTimeToHumanTime(m);var h=!0,g=changeJsTimeToHumanTime(m,h);myTime.expectedExitTime=howLongToCompleteNineHours(g[0],g[1]),t(myTime.convertedTotalTime,myTime.expectedExitTime)}function renderStatus(e,t){var a="headerText";t&&(a=t),document.getElementById(a).innerHTML=e}function renderCalender(e,t){document.getElementById("card"+t).addEventListener("click",function(){otch(e.htmlLink)}),document.getElementById("timeCard"+t).innerHTML=e.time,document.getElementById("timeLeftCard"+t).innerHTML=e.timeLeft,document.getElementById("summaryCard"+t).innerHTML=e.summary,window.navigator.online||showContent(["googleCal"])}function toggleLoader(e){e===!0?document.getElementById("overlay").className="visible":document.getElementById("overlay").className="hidden"}function toggleLogo(){var e=document.getElementById("topCornerIcon");e.classList.contains("home-logo")?e.classList.contains("home-logo")&&(e.classList.remove("home-logo"),hideContent(["settingsPage"]),chrome.storage.local.get("cal",function(e){showContent(e&&e.cal&&e.cal.permitted?["homePage","googleCal"]:["homePage"])})):(e.classList.add("home-logo"),user.eCode&&(hideContent(["homePage","googleCal"]),app.calenderShown=!1,showContent(["settingsPage"])))}function hideContent(e){if("string"==typeof e)document.getElementById(e).classList.add("hidden");else for(var t in e)document.getElementById(e[t]).classList.add("hidden")}function showContent(e){if("string"==typeof e)document.getElementById(e).classList.remove("hidden");else for(var t in e)document.getElementById(e[t]).classList.remove("hidden")}function handleNotLoggedIn(e,t,a){var n=t;hideContent(["walkThrough","topCornerIcon","settingsPage"]),showContent(["infoPage","header"]),renderStatus("Photon Track status"),renderStatus(e+" "+n+" seconds","content"),n--;var o=setInterval(function(){var t;t=n>1?" seconds":" second",renderStatus(e+" "+n+t,"content"),n--,0===n&&clearInterval(o)},1e3);switch(a){case"focusTab":setTimeout(function(){chrome.tabs.update(app.pulseTabId,{active:!0})},1e3*t);break;case"openTab":setTimeout(function(){chrome.tabs.create({url:app.pulseUrl})},1e3*t);break;case"activeTab":setTimeout(function(){window.close()},1e3*t);break;case"googleCal":setTimeout(function(){gCalInit()},1e3*t)}}function attachOnMessageEventListener(){chrome.runtime.onMessage.addListener(function(e,t){app.urlRegex.test(t.url)&&(e&&e.eCode?(user.eCode=e.eCode,chrome.storage.local.set({user:user},function(){user.eCode=e.eCode,console.log("user.eCode is received and set as : "+user.eCode),chrome.storage.local.get("googlePopUp",function(e){e&&e.googlePopUp&&e.googlePopUp.opened?(console.log("calendar was opened once"),setTimeout(function(){document.getElementById("iFrame").src="https://accessreporting.photoninfotech.com/accessreportDetails"},500)):(console.log("calendar local value is not set. Calling pop up"),handleNotLoggedIn("Please provide calender permission and close the popup thereafter. \nOpening Google calendar permission popup in",5,"googleCal"))})})):e&&e.notLoggedIn&&!app.pulseActive?handleNotLoggedIn("Pulse is open but you are not logged in. \n\nRedirecting to the tab in",5,"focusTab"):e&&e.notLoggedIn&&app.pulseActive&&handleNotLoggedIn("Please log in to Pulse. \n\nPop up will disappear in",5,"activeTab"))})}function isEmpty(e){for(var t in e)return!1;return!0}function addClickHandlers(){document.getElementById("startButton").addEventListener("click",stch),document.getElementById("mailToIcon").addEventListener("click",mtch),document.getElementById("topCornerIcon").addEventListener("click",sech),document.getElementById("clearPhotonButton").addEventListener("click",function(){cbch("photon")}),document.getElementById("clearCalButton").addEventListener("click",function(){cbch("cal")}),document.getElementById("clearAllButton").addEventListener("click",function(){cbch("all")}),document.getElementById("infoIcon").addEventListener("click",function(){otch(app.reviewUrl)})}function otch(e){chrome.tabs.create({url:e})}function cbch(e){switch(e){case"photon":chrome.storage.local.remove("user",function(){user={tempECode:null,eCode:null,name:null,weekData:null,monthData:null},hideContent(["homePage","settingsPage","header"]),showContent(["walkThrough","googleCal"])});break;case"cal":chrome.storage.local.remove("googlePopUp"),chrome.storage.local.remove("cal",function(){hideContent(["settingsPage","walkThrough"]),showContent(["homePage","header"]),otch(app.resetGCalUrl)});break;case"all":chrome.storage.local.clear(function(){otch(app.resetGCalUrl),user={tempECode:null,eCode:null,name:null,weekData:null,monthData:null},hideContent(["homePage","settingsPage","header"]),showContent(["walkThrough"])})}}function sech(){toggleLogo(),app.settingsMode=!0}function mtch(){chrome.tabs.create({url:app.feedbackUrl},function(){console.log("success")})}function callback(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message)}function searchTabs(e){chrome.tabs.query({},function(e){for(var t in e)if(app.urlRegex.test(e[t].url)){if(app.pulseTabId=e[t].id,app.pulseActive=e[t].active,"loading"===e[t].status){toggleLoader(!0);var a=0,n=setInterval(function(){a++,"complete"===e[t].status?(chrome.tabs.executeScript(e[t].id,{file:"app/js/injector.js"},callback),clearInterval(n)):a>5&&clearInterval(n)},1e3)}else chrome.tabs.executeScript(e[t].id,{file:"app/js/injector.js"},callback);break}app.pulseTabId||handleNotLoggedIn("You are not authenticated yet. Opening Pulse in",5,"openTab")})}function stch(e,t){console.log("stch");var a={started:!0};chrome.storage.local.get("user_action",function(e){isEmpty(e)&&!t?(console.log("setted user action"),chrome.storage.local.set({user_action:a}),searchTabs()):e&&e.user_action&&e.user_action.started?(console.log("programmatic searching tabs"),searchTabs(t)):console.log("just opened app")})}function formatAMPM(e){var t=e.getHours(),a=e.getMinutes(),n=t>=12?"pm":"am";t%=12,t=t?t:12,a=10>a?"0"+a:a;var o=t+":"+a+" "+n;return o}function calendarDisplayLogic(e){var t=new Date,a=864e5,n=function(e,t){var n=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),o=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((o-n)/a)};for(var o in e){var r=changeJsTimeToHumanTime(e[o].when-t,!0),s=r[1]?r[1]+" mins":"",c=n(t,e[o].when),i=c>0?c>1?c+" days ":c+" day ":"";e[o].timeLeft=i+r[0]+" hrs "+s+" left",e[o].time=formatAMPM(e[o].when);var l=Number(o)+1;renderCalender(e[o],l)}}function gCalInit(){var e={CLIENT_ID:"183365371926-3c8jqt5rn0h0acnpf3782vb8mi86v6u4.apps.googleusercontent.com",SCOPES:["https://www.googleapis.com/auth/calendar.readonly"],userCal:[],handleAuthClick:function(t){return gapi.auth.authorize({client_id:e.CLIENT_ID,scope:e.SCOPES,immediate:!1},e.handleAuthResult),!1},listUpcomingEvents:function(){var t=gapi.client.calendar.events.list({calendarId:"primary",timeMin:(new Date).toISOString(),showDeleted:!1,singleEvents:!0,maxResults:3,orderBy:"startTime"});t.execute(function(t){var a=t.items;if(a.length>0)for(i=0;i<a.length;i++){var n={},o=a[i],r=new Date(o.start.dateTime);r||new Date(r=o.start.date);var n={summary:o.summary,when:r,creator:o.creator.displayName,htmlLink:o.htmlLink};e.userCal.push(n)}app.calenderData=e.userCal;var s={permitted:!0};chrome.storage.local.set({cal:s},function(){console.log("Calender condition is set to true"),showCalenderIfPermitted()})})},loadCalendarApi:function(){gapi.client.load("calendar","v3",e.listUpcomingEvents)},handleAuthResult:function(t){t&&!t.error?e.loadCalendarApi():e.handleAuthClick()},checkAuth:function(){console.log("checkAuth entered"),chrome.storage.local.get("user",function(t){if(t&&t.user&&t.user.eCode){console.log("checkAuth gonna run as eCode is availablw");var a={opened:!0};chrome.storage.local.set({googlePopUp:a}),gapi.auth.authorize({client_id:e.CLIENT_ID,scope:e.SCOPES.join(" "),immediate:!0},e.handleAuthResult)}else chrome.storage.local.get("cal",function(t){t&&t.cal&&t.cal.permitted&&(console.log("Calendar value is availble and will be visible"),gapi.auth.authorize({client_id:e.CLIENT_ID,scope:e.SCOPES.join(" "),immediate:!0},e.handleAuthResult))})})}};e.checkAuth()}var analyticsModifierForLocal=!1,dimensionValue="user";!function(e,t,a,n,o,r,s){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,r=t.createElement(a),s=t.getElementsByTagName(a)[0],r.async=1,r.src=n,s.parentNode.insertBefore(r,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),analyticsModifierForLocal?ga("create","UA-75254050-1","auto"):ga("create","UA-75254050-2","auto"),ga("set","checkProtocolTask",function(){}),ga("require","displayfeatures"),ga("set","dimension1",dimensionValue),ga("send","pageview","/options.html");var today=new Date,myTime={d:today.getDate(),m:today.getMonth()+1,y:today.getFullYear(),fromDay:today.getDate()-today.getDay()+1,inTime:null,calculatedTotalMs:null,convertedTotalTime:null,expectedExitTime:null,crossedNineHours:!1};myTime["dt-"]=myTime.y+"-"+myTime.m+"-"+myTime.d,myTime["dt/"]=myTime.y+"/"+myTime.m+"/"+myTime.d,myTime.wholeM=myTime.y+"/"+myTime.m+"/01",myTime.wholeW=myTime.y+"/"+myTime.m+"/"+myTime.fromDay;var user={tempECode:null,eCode:null,name:null,weekData:null,monthData:null},app={pulseUrl:"https://pulse.photoninfotech.com/",pulseTabId:null,pulseActive:!1,reviewUrl:"https://chrome.google.com/webstore/detail/photon-track/abkcmkmcbdhidgiapklpnbiblehjigka/reviews",dataUrl:"https://accessreporting.photoninfotech.com/getReporteesData",swipeDataUrl:"https://accessreporting.photoninfotech.com/getSwipedetails",weekAndMonthData:{week:null,month:null},urlRegex:/^https?:\/\/(?:[^.\/?#]+\.)?photoninfotech\.com/,localServiceMode:!1,settingsMode:!1,feedbackUrl:"https://mail.google.com/mail/?view=cm&fs=1&tf=1&to=vikram.menon@photoninfotech.net&su=Comments/Feedback for Photon track plus extension&body=Hi Vikram,",resetGCalUrl:"https://security.google.com/settings/security/permissions?pli=1",showCalEvents:1,calenderData:null,calenderShown:!1,version:null};app.version=chrome.runtime.getManifest().version,document.addEventListener("DOMContentLoaded",function(){attachOnMessageEventListener(),addClickHandlers(),document.getElementById("iFrame").onload=function(e){getDataAfterPulseAndAccesssControl(user.tempECode)},renderStatus("version "+app.version,"version-label"),launchChecks()});var getFactory=function(e,t,a){var n;switch(e){case"month":var o=user.eCode?user.eCode:user.tempECode;n=app.dataUrl+"?EmpId="+o+"&startdate="+myTime.wholeM+"&enddate="+myTime["dt/"];break;case"week":var o=user.eCode?user.eCode:user.tempECode;n=app.dataUrl+"?EmpId="+o+"&startdate="+myTime.wholeW+"&enddate="+myTime["dt/"];break;case"today":n=app.swipeDataUrl+"?EmpId="+user.eCode+"&date="+myTime["dt-"]}var r=function(){var e=new XMLHttpRequest;e.open("GET",n,!0),e.onreadystatechange=function(t){4===e.readyState&&(200===e.status||a(e.statusText))},e.onload=function(){var n=e.response;return n?(n=JSON.parse(n),void t(n)):void a("No response")},e.onerror=function(e){a("Network error")},e.send()};return app.localServiceMode?localService(e):new r},localService=function(e){return localData={},localData.month=[{employeeId:"104256",first_in_time:["14:25:18","12:01:56","13:46:09","12:33:48","12:58:57","13:39:19","13:14:25","12:50:56","11:00:43","12:05:34","11:07:48","10:58:09","12:18:53","12:16:09","14:43:49"],last_out_time:["00:01:11","22:35:46","22:00:30","21:24:03","22:34:23","22:25:22","21:27:04","22:44:39","23:30:48","21:49:34","20:46:33","23:17:46","22:47:27","22:33:05","17:42:40"],productiveHours:"131:30",eachDayprohrs:["08:20","09:58","07:26","07:58","08:44","08:15","07:51","09:14","11:15","09:09","09:26","11:28","09:26","10:01","02:59"],eachDaytotalProdhrs:["09:36","10:34","08:14","08:51","09:36","08:46","08:13","09:54","12:30","09:44","09:39","12:19","10:29","10:17","02:59"],eachDate:["2016-03-01","2016-03-02","2016-03-03","2016-03-04","2016-03-07","2016-03-08","2016-03-09","2016-03-10","2016-03-11","2016-03-14","2016-03-15","2016-03-16","2016-03-17","2016-03-18","2016-03-19"],total_time_hrs:[],timesheet_date:[],total_timesht_hours:"undefined:00",avg_hrs:"09:23",workoutside:[],displayName:"Vikram M Menon",location:"Bangalore - ITPL",shiftTime:"9AM - 7PM ",businessCategory:"ENGINEERING",mngDisplayName:"Venkata Bharaniraj U",managerDisplayName:"Venkata Bharaniraj U"}],localData.today=[{data:["2016-03-11","11:00:43","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","11:51:36","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-11","12:05:57","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","13:47:42","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-11","13:47:58","Entry","Second","Main Entrance","Successful"]},{data:["2016-03-11","14:08:48","Exit","Second","Main Entrance","Successful"]},{data:["2016-03-11","14:12:13","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","14:39:45","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-11","14:53:30","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","19:59:40","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-11","20:06:55","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","21:16:00","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-11","21:52:40","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-11","23:30:48","Exit","Ground","Main Entrance","Successful"]}],localData.previous=[{data:["2016-03-10","12:50:56","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-10","13:17:56","Entry","Second","Main Entrance","Successful"]},{data:["2016-03-10","13:18:25","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-10","13:45:57","Exit","Second","Main Entrance","Successful"]},{data:["2016-03-10","13:49:17","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-10","15:01:58","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-10","15:14:28","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-10","15:21:01","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-10","15:21:44","Entry","Second","Main Entrance","Successful"]},{data:["2016-03-10","16:47:24","Exit","Second","Main Entrance","Successful"]},{data:["2016-03-10","16:51:53","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-10","18:03:12","Exit","Ground","Main Entrance","Successful"]},{data:["2016-03-10","18:23:17","Entry","Ground","Main Entrance","Successful"]},{data:["2016-03-10","22:44:39","Exit","Ground","Main Entrance","Successful"]}],localData.week=[{employeeId:"104256",first_in_time:["12:05:34","11:07:48","10:58:09","12:18:53","12:16:09","14:43:49"],last_out_time:["21:49:34","20:46:33","23:17:46","22:47:27","22:33:05","17:42:40"],productiveHours:"52:29",eachDayprohrs:["09:09","09:26","11:28","09:26","10:01","02:59"],eachDaytotalProdhrs:["09:44","09:39","12:19","10:29","10:17","02:59"],eachDate:["2016-03-14","2016-03-15","2016-03-16","2016-03-17","2016-03-18","2016-03-19"],total_time_hrs:[],timesheet_date:[],total_timesht_hours:"undefined:00",avg_hrs:"10:29",workoutside:[],displayName:"Vikram M Menon",location:"Bangalore - ITPL",shiftTime:"9AM - 7PM ",businessCategory:"ENGINEERING",mngDisplayName:"Venkata Bharaniraj U",managerDisplayName:"Venkata Bharaniraj U"}],localData[e]},localCalData=[{summary:"ME Internal Syncup",when:"2016-03-28T12:45:00.000Z",creator:"Javed Ansari"},{summary:"MarketEDGE Daily Defect Review",when:"2016-03-28T13:00:00.000Z",creator:"Vikram Menon"},{summary:"ME Defect Review Meeting",when:"2016-03-28T13:00:00.000Z",creator:"Javed Ansari"}];